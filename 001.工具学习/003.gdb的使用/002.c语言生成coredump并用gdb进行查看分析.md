# c语言生成coredump并使用gdb进行查看分析

- [c语言生成coredump并使用gdb进行查看分析](#c语言生成coredump并使用gdb进行查看分析)
  - [1. 配置coredump](#1-配置coredump)
  - [2. 代码准备](#2-代码准备)
  - [3. 使用 gdb 查看分析 coredump 文件](#3-使用-gdb-查看分析-coredump-文件)

## 1. 配置coredump

1. 打开coredump的生成开关

```bash
# 查看 ulimit 命令帮助
ulimit --help

# 查看当前 ulimit 的所有设置
ulimit -a

# 打开 coredump 生成开关(core file size, 默认为0)
ulimit -c unlimited
```

2. 设置 coredump 生成文件目录和格式

```bash
echo '/code/core/dump_%t-%e-%p-%c.core' > /proc/sys/kernel/core_pattern
```

- %e出core进程的pid
- %u出core进程的UID
- %s造成core的signal号
- %t出core的时间，从1970-01-0100:00:00开始的秒数
- %e出core进程对应的可执行文件名

## 2. 代码准备

- 代码

```c
// core.c
#include <stdio.h>

int div(int total, int piece)
{
    return total / piece;
}

int main()
{
    int total = {100};
    for (int i = 0; i < 1000; i++)
    {
        // 当 i=100 时，函数内除数为0，将引发异常退出，从而产生 coredump
        printf("total: %d, piece: %d, div: %d", total, i, div(total, i));
    }
    return 0;
}
```

- 编译

```bash
gcc -g core.c -o core
```

- 运行二进制文件

```bash
> ./core 
浮点数例外 (核心已转储)
```

- 查看core文件

```bash
> ls /code/core
dump_1675751046-core-21577-18446744073709551615.core
```


## 3. 使用 gdb 查看分析 coredump 文件

很清除看到在 core.c 文件的第 5 行出现了除数为0 导致异常

```bash
gdb ./core dump_1675751046-core-21577-18446744073709551615.core
GNU gdb (Ubuntu 9.1-0ubuntu1) 9.1
Copyright (C) 2020 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type "show copying" and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
    <http://www.gnu.org/software/gdb/documentation/>.

For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from ./core...
[New LWP 21577]
Core was generated by `./core'.
Program terminated with signal SIGFPE, Arithmetic exception.
#0  0x0000558aab52315b in div (total=100, piece=0) at core.c:5
5	    return total / piece;
(gdb) 
```
